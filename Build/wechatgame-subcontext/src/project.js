window.__require=function e(o,n,t){function a(c,s){if(!n[c]){if(!o[c]){var i=c.split("/");if(i=i[i.length-1],!o[i]){var l="function"==typeof __require&&__require;if(!s&&l)return l(i,!0);if(r)return r(i,!0);throw new Error("Cannot find module '"+c+"'")}}var u=n[c]={exports:{}};o[c][0].call(u.exports,function(e){return a(o[c][1][e]||e)},u,u.exports,e,o,n,t)}return n[c].exports}for(var r="function"==typeof __require&&__require,c=0;c<t.length;c++)a(t[c]);return a}({OpenCommon:[function(e,o,n){"use strict";cc._RF.push(o,"7ab32OHYWpBS7cbtmam5P1W","OpenCommon"),Object.defineProperty(n,"__esModule",{value:!0});var t=function(){function e(){}return e.localStorageMap=new Map,e}();n.OpenCommon=t,cc._RF.pop()},{}],launch:[function(e,o,n){"use strict";cc._RF.push(o,"ca4b9VB3alCN6vjaIjw3pSB","launch");var t=e("./OpenCommon");cc.Class({extends:cc.Component,properties:{content:cc.Node,prefab:cc.Prefab},onLoad:function(){this.getUserInfo(function(e){console.info("[\u83b7\u53d6\u7528\u6237\u4fe1\u606f]"+e)}),this.getUserMaxScoreData(function(e){t.OpenCommon.maxScore=e,console.info("[\u83b7\u53d6\u7528\u6237\u6700\u9ad8\u5206]"+e)})},start:function(){var e=this;this.rank=0,wx.onMessage(function(o){o&&o.message&&e.resolveMessage(o.message)})},createUserBlock:function(e){var o=this.createPrefab(),n=void 0,t=void 0,a=void 0;e&&(n=e.nickName?e.nickName:e.nickname,t=e.avatarUrl,a=this.resolveCloudStorage(e.KVDataList,"OneEatMaxScore"),e.openid);var r=o.getChildByName("rank").getComponent(cc.Label),c=o.getChildByName("userName").getComponent(cc.Label),s=o.getChildByName("mask").children[0].getComponent(cc.Sprite),i=o.getChildByName("userScore").getComponent(cc.Label);if(s.enabled=!1,n){if(a)switch(this.rank+=1,r.string=this.rank,this.rank){case 1:r.node.color=new cc.Color(255,0,0);break;case 2:r.node.color=new cc.Color(0,255,0);break;case 3:r.node.color=new cc.Color(0,0,255);break;default:r.fontSize=r.fontSize/2}else a="null",r.string="null";c.string=n,i.string=a,console.log("[\u83b7\u53d6\u597d\u53cb\u4fe1\u606f]"+n),t&&cc.loader.load({url:t,type:"png"},function(e,o){e&&console.error(e),s.enabled=!0,s.spriteFrame=new cc.SpriteFrame(o)}),o.on(cc.Node.EventType.TOUCH_START,function(){},this)}else c.string="",i.string="",s.spriteFrame="",r.string=""},createPrefab:function(){var e=cc.instantiate(this.prefab);return e.parent=this.content,e},resolveMessage:function(e){switch(e.type){case"command":this.resolveCommand(e.function,e.arguments,e.data)}},resolveCommand:function(e,o,n){var a=this;switch(e){case"clear":this.clearContext();break;case"preload":switch(o){case"friend":this.updateFriendInfo(["OneEatMaxScore"]);break;case"group":this.updateGroupInfo(n,["OneEatMaxScore"])}break;case"start":new Promise(function(e){a.clearContext(),a.getUserInfo(function(o){e(o)}),n&&n.width&&n.height&&(a.getComponent(cc.Canvas).designResolution=new cc.size(n.width,n.height))}).then(function(e){a.getFriendInfo(["OneEatMaxScore"])});break;case"switch":switch(this.clearContext(),o){case"friend":this.getFriendInfo(["OneEatMaxScore"]);break;case"group":n&&(t.OpenCommon.lastTicket=n,this.getGroupInfo(n,["OneEatMaxScore"]))}break;case"save":switch(o){case"gameDiamond":case"gameCurrency":break;case"score":this.saveMaxScoreData(n)}}},clearContext:function(){this.rank=0,this.content.removeAllChildren()},getUserInfo:function(e){var o=this;t.OpenCommon.userInfo?e(!0):wx.getUserInfo({openIdList:["selfOpenId"],lang:"zh_CN",success:function(n){var a=n.data[0];t.OpenCommon.userInfo=a,o.getUserMaxScoreData(function(n){var t=a.nickName,r=a.avatarUrl,c=n;if(o.userBlock){var s=o.userBlock.getChildByName("Mask").getComponentInChildren(cc.Sprite),i=o.userBlock.getChildByName("Name").getComponent(cc.Label),l=o.userBlock.getChildByName("Score").getComponent(cc.Label);i.string=t,cc.loader.load({url:r,type:"png"},function(e,o){e&&console.error(e),s.spriteFrame=new cc.SpriteFrame(o)}),l.string=c?n:"null"}e(!0)})},fail:function(o){e(!1)}})},updateFriendInfo:function(e){var o=this;wx.getFriendCloudStorage({keyList:e,success:function(e){console.info("[\u6210\u529f\u66f4\u65b0\u670b\u53cb\u4fe1\u606f]",e.data),o.resolveInfo("Friend","OneEatMaxScore",e.data)},fail:function(e){console.error(e)}})},getFriendInfo:function(e){var o=this,n=void 0;if(t.OpenCommon.localStorageMap.has("Friend")){var a=t.OpenCommon.localStorageMap.get("Friend");n=[];for(var r=0;r<e.length;r++)if(a.has(e[r])){var c=a.get(e[r]);o.createInfoBlock(c,10)}else n.push(e[r])}else n=e;n.length>0&&wx.getFriendCloudStorage({keyList:e,success:function(e){console.info("[\u6210\u529f\u83b7\u53d6\u670b\u53cb\u4fe1\u606f]",e.data);var n=o.resolveInfo("Friend","OneEatMaxScore",e.data);o.createInfoBlock(n,10)},fail:function(e){console.error(e)}})},resolveInfo:function(e,o,n){this.sortList(n,o,!1);var a=void 0;return t.OpenCommon.localStorageMap.has(e)?a=t.OpenCommon.localStorageMap.get(e):(a=new Map,t.OpenCommon.localStorageMap.set(e,a)),a.set(o,n),n},createInfoBlock:function(e,o){var n=void 0;n=e.length>o?e.length:o;for(var t=0;t<n;t++){var a=e[t];a?this.createUserBlock(a):this.createUserBlock()}},updateGroupInfo:function(e,o){var n=this;wx.getGroupCloudStorage({shareTicket:e,keyList:o,success:function(e){console.info("[\u6210\u529f\u66f4\u65b0\u7fa4\u7ec4\u4fe1\u606f]",e.data),n.resolveInfo("Group","OneEatMaxScore",e.data)},fail:function(e){console.error(e)}})},getGroupInfo:function(e,o){var n=this,a=void 0;if(t.OpenCommon.localStorageMap.has("Group")){var r=t.OpenCommon.localStorageMap.get("Group");a=[];for(var c=0;c<o.length;c++)if(r.has(o[c])){var s=r.get(o[c]);n.createInfoBlock(s,10)}else a.push(o[c])}else a=o;a.length>0&&wx.getGroupCloudStorage({shareTicket:e,keyList:o,success:function(e){var o=n.resolveInfo("Group","OneEatMaxScore",e.data);n.createInfoBlock(o,10)},fail:function(e){console.error(e)}})},getUserMaxScoreData:function(e){var o=this,n=new Array;n.push("OneEatMaxScore"),wx.getUserCloudStorage({keyList:n,success:function(n){var a=o.resolveCloudStorage(n.KVDataList,"OneEatMaxScore");a?(console.info("[\u83b7\u53d6\u6258\u7ba1\u6700\u9ad8\u5206\u6210\u529f]"+a),e(a)):(o.saveMaxScoreData(0),e(0)),t.OpenCommon.isGetMaxScoreSuccess=!0},fail:function(o){t.OpenCommon.isGetMaxScoreSuccess=!1,e(0)}})},resolveCloudStorage:function(e,o){if(!e)return null;for(var n=0;n<e.length;n++)if(e[n].key===o)return e[n].value},saveCloudStorage:function(e,o,n){wx.setUserCloudStorage({KVDataList:e,success:o,fail:n})},saveMaxScoreData:function(e){var o=this;if(!t.OpenCommon.maxScore||e<=t.OpenCommon.maxScore)console.info("[\u6700\u9ad8\u5206]"+t.OpenCommon.maxScore+"[\u4f46\u5b58\u50a8\u503c]"+e+"[\u8fc7\u4f4e]");else{var n=["OneEatMaxScore"],a=new Array;a.push({key:n[0],value:""+e}),t.OpenCommon.lastTicket&&this.updateGroupInfo(t.OpenCommon.lastTicket,n),this.saveCloudStorage(a,function(){console.info("[\u5b58\u50a8\u6700\u9ad8\u5206\u6570\u636e\u6210\u529f]"),o.updateFriendInfo(n)},function(){console.info("[\u5b58\u50a8\u6700\u9ad8\u5206\u6570\u636e\u5931\u8d25]")})}},sortList:function(e,o,n){return e.sort(function(e,t){for(var a=0,r=e.KVDataList,c=0;c<r.length;c++)r[c].key==o&&(a=r[c].value);var s=0;r=t.KVDataList;for(var i=0;i<r.length;i++)r[i].key==o&&(s=r[i].value);return n?parseInt(a)-parseInt(s):parseInt(s)-parseInt(a)}),e}}),cc._RF.pop()},{"./OpenCommon":"OpenCommon"}]},{},["OpenCommon","launch"]);
//# sourceMappingURL=project.js.map