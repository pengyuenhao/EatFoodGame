window.__require=function e(o,n,t){function r(c,s){if(!n[c]){if(!o[c]){var i=c.split("/");if(i=i[i.length-1],!o[i]){var l="function"==typeof __require&&__require;if(!s&&l)return l(i,!0);if(a)return a(i,!0);throw new Error("Cannot find module '"+c+"'")}}var u=n[c]={exports:{}};o[c][0].call(u.exports,function(e){return r(o[c][1][e]||e)},u,u.exports,e,o,n,t)}return n[c].exports}for(var a="function"==typeof __require&&__require,c=0;c<t.length;c++)r(t[c]);return r}({OpenCommon:[function(e,o,n){"use strict";cc._RF.push(o,"7ab32OHYWpBS7cbtmam5P1W","OpenCommon"),Object.defineProperty(n,"__esModule",{value:!0});var t=function(){function e(){}return e.localStorageMap=new Map,e}();n.OpenCommon=t,cc._RF.pop()},{}],launch:[function(e,o,n){"use strict";cc._RF.push(o,"ca4b9VB3alCN6vjaIjw3pSB","launch");var t=e("./OpenCommon");cc.Class({extends:cc.Component,properties:{content:cc.Node,prefab:cc.Prefab},onLoad:function(){var e=this;this.getUserInfo(function(e){console.info("[\u83b7\u53d6\u7528\u6237\u4fe1\u606f]"+e)}),this.getUserMaxScoreData(function(o){t.OpenCommon.maxScore=o,0===o&&e.saveMaxScoreData(0),null===o||void 0===o?console.error("[\u83b7\u53d6\u7528\u6237\u6700\u9ad8\u5206\u5931\u8d25]"+o):console.info("[\u83b7\u53d6\u7528\u6237\u6700\u9ad8\u5206]"+o)})},start:function(){var e=this;this.rank=0,wx.onMessage(function(o){o&&o.message&&e.resolveMessage(o.message)}),setTimeout(function(){0},1e3)},createUserBlock:function(e){var o=this.createPrefab(),n=void 0,t=void 0,r=void 0;e&&(n=e.nickName?e.nickName:e.nickname,t=e.avatarUrl,r=this.resolveCloudStorage(e.KVDataList,"OneEatMaxScore"),e.openid);var a=o.getChildByName("rank").getComponent(cc.Label),c=o.getChildByName("userName").getComponent(cc.Label),s=o.getChildByName("mask").children[0].getComponent(cc.Sprite),i=o.getChildByName("userScore").getComponent(cc.Label);if(s.enabled=!1,n){if(r)switch(this.rank+=1,a.string=this.rank,this.rank){case 1:a.node.color=new cc.Color(255,0,0);break;case 2:a.node.color=new cc.Color(0,255,0);break;case 3:a.node.color=new cc.Color(0,0,255);break;default:a.fontSize=a.fontSize/2}else r="null",a.string="null";c.string=n,i.string=r,t&&cc.loader.load({url:t,type:"png"},function(e,o){e&&console.error(e),s.enabled=!0,s.spriteFrame=new cc.SpriteFrame(o)}),o.on(cc.Node.EventType.TOUCH_START,function(){},this)}else c.string="",i.string="",s.spriteFrame="",a.string=""},createPrefab:function(){var e=cc.instantiate(this.prefab);return e.parent=this.content,e},resolveMessage:function(e){switch(e.type){case"command":this.resolveCommand(e.function,e.arguments,e.data)}},resolveCommand:function(e,o,n){var r=this;switch(e){case"clear":this.clearContext();break;case"preload":switch(o){case"friend":this.updateFriendInfo(["OneEatMaxScore"]);break;case"group":this.updateGroupInfo(n,["OneEatMaxScore"])}break;case"start":new Promise(function(e){r.clearContext(),r.getUserInfo(function(o){e(o)}),n&&n.width&&n.height&&(r.getComponent(cc.Canvas).designResolution=new cc.size(n.width,n.height))}).then(function(e){r.getFriendInfo(["OneEatMaxScore"])});break;case"switch":switch(this.clearContext(),o){case"friend":this.getFriendInfo(["OneEatMaxScore"]);break;case"group":n&&(t.OpenCommon.lastTicket=n,this.getGroupInfo(n,["OneEatMaxScore"]))}break;case"save":switch(o){case"gameDiamond":case"gameCurrency":break;case"score":this.saveMaxScoreData(n)}}},clearContext:function(){this.rank=0,this.content.removeAllChildren()},getUserInfo:function(e){var o=this;t.OpenCommon.userInfo?e(!0):wx.getUserInfo({openIdList:["selfOpenId"],lang:"zh_CN",success:function(n){var r=n.data[0];t.OpenCommon.userInfo=r,o.getUserMaxScoreData(function(n){var t=r.nickName,a=r.avatarUrl,c=n;if(o.userBlock){var s=o.userBlock.getChildByName("Mask").getComponentInChildren(cc.Sprite),i=o.userBlock.getChildByName("Name").getComponent(cc.Label),l=o.userBlock.getChildByName("Score").getComponent(cc.Label);i.string=t,cc.loader.load({url:a,type:"png"},function(e,o){e&&console.error(e),s.spriteFrame=new cc.SpriteFrame(o)}),l.string=c?n:"null"}e(!0)})},fail:function(o){e(!1)}})},updateFriendInfo:function(e){var o=this;wx.getFriendCloudStorage({keyList:e,success:function(e){o.resolveInfo("Friend","OneEatMaxScore",e.data)},fail:function(e){console.error(e)}})},getFriendInfo:function(e){var o=this,n=void 0;if(t.OpenCommon.localStorageMap.has("Friend")){var r=t.OpenCommon.localStorageMap.get("Friend");n=[];for(var a=0;a<e.length;a++)if(r.has(e[a])){var c=r.get(e[a]);o.createInfoBlock(c,10)}else n.push(e[a])}else n=e;n.length>0&&wx.getFriendCloudStorage({keyList:e,success:function(e){var n=o.resolveInfo("Friend","OneEatMaxScore",e.data);o.createInfoBlock(n,10)},fail:function(e){console.error(e)}})},resolveInfo:function(e,o,n){this.sortList(n,o,!1);var r=void 0;return t.OpenCommon.localStorageMap.has(e)?r=t.OpenCommon.localStorageMap.get(e):(r=new Map,t.OpenCommon.localStorageMap.set(e,r)),r.set(o,n),n},createInfoBlock:function(e,o){var n=void 0;n=e.length>o?e.length:o;for(var t=0;t<n;t++){var r=e[t];r?this.createUserBlock(r):this.createUserBlock()}},updateGroupInfo:function(e,o){var n=this;wx.getGroupCloudStorage({shareTicket:e,keyList:o,success:function(e){n.resolveInfo("Group","OneEatMaxScore",e.data)},fail:function(e){console.error(e)}})},getGroupInfo:function(e,o){var n=this,r=void 0;if(t.OpenCommon.localStorageMap.has("Group")){var a=t.OpenCommon.localStorageMap.get("Group");r=[];for(var c=0;c<o.length;c++)if(a.has(o[c])){var s=a.get(o[c]);n.createInfoBlock(s,10)}else r.push(o[c])}else r=o;r.length>0&&wx.getGroupCloudStorage({shareTicket:e,keyList:o,success:function(e){var o=n.resolveInfo("Group","OneEatMaxScore",e.data);n.createInfoBlock(o,10)},fail:function(e){console.error(e)}})},getUserMaxScoreData:function(e){var o=this,n=new Array;n.push("OneEatMaxScore"),wx.getUserCloudStorage({keyList:n,success:function(n){var r=o.resolveCloudStorage(n.KVDataList,"OneEatMaxScore");r?(console.info("[\u83b7\u53d6\u6258\u7ba1\u6700\u9ad8\u5206\u6210\u529f]"+r),e(r)):(console.info("[\u83b7\u53d6\u7ed3\u679c\u4e3a\u65b0\u7528\u6237]"+r),e(0)),t.OpenCommon.isGetMaxScoreSuccess=!0},fail:function(o){t.OpenCommon.isGetMaxScoreSuccess=!1,e(null)}})},resolveCloudStorage:function(e,o){if(!e)return null;for(var n=0;n<e.length;n++)if(e[n].key===o)return e[n].value},saveCloudStorage:function(e,o,n){wx.setUserCloudStorage({KVDataList:e,success:o,fail:n})},saveMaxScoreData:function(e){var o=this;if(null===t.OpenCommon.maxScore||void 0===t.OpenCommon.maxScore||0!==e&&e<=t.OpenCommon.maxScore)console.info("[\u4e0d\u5b58\u50a8\u6700\u9ad8\u5206]"+t.OpenCommon.maxScore+"[\u5206\u503c]"+e+"[\u8fc7\u4f4e]");else{var n=["OneEatMaxScore"],r=new Array;r.push({key:n[0],value:""+e}),t.OpenCommon.lastTicket&&this.updateGroupInfo(t.OpenCommon.lastTicket,n),this.saveCloudStorage(r,function(){console.info("[\u5b58\u50a8\u6700\u9ad8\u5206\u6570\u636e\u6210\u529f]"+e),o.updateFriendInfo(n)},function(){console.error("[\u5b58\u50a8\u6700\u9ad8\u5206\u6570\u636e\u5931\u8d25]"+e)})}},sortList:function(e,o,n){return e.sort(function(e,t){for(var r=0,a=e.KVDataList,c=0;c<a.length;c++)a[c].key==o&&(r=a[c].value);var s=0;a=t.KVDataList;for(var i=0;i<a.length;i++)a[i].key==o&&(s=a[i].value);return n?parseInt(r)-parseInt(s):parseInt(s)-parseInt(r)}),e}}),cc._RF.pop()},{"./OpenCommon":"OpenCommon"}]},{},["OpenCommon","launch"]);
//# sourceMappingURL=project.js.map