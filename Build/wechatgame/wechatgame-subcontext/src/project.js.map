{"version":3,"sources":["assets/scripts/OpenCommon.ts","assets/scripts/launch.js"],"names":["OpenCommon","localStorageMap","Map","exports","_OpenCommon","require","cc","Class","extends","Component","properties","content","Node","prefab","Prefab","onLoad","this","getUserInfo","result","console","info","getUserMaxScoreData","maxScore","start","that","rank","wx","onMessage","data","message","resolveMessage","createUserBlock","user","node","createPrefab","nickName","avatarUrl","score","nickname","resolveCloudStorage","KVDataList","openid","userRank","getChildByName","getComponent","Label","userName","userIcon","children","Sprite","userScore","enabled","string","color","Color","fontSize","log","loader","load","url","type","err","texture","error","spriteFrame","SpriteFrame","on","EventType","TOUCH_START","instantiate","parent","resolveCommand","function","arguments","func","args","_this","clearContext","updateFriendInfo","updateGroupInfo","Promise","resolve","width","height","Canvas","designResolution","size","then","getFriendInfo","lastTicket","getGroupInfo","saveMaxScoreData","removeAllChildren","userInfo","openIdList","lang","success","res","userBlock","userAvatarSprite","getComponentInChildren","nickNameLabel","maxScoreLabel","fail","keys","getFriendCloudStorage","keyList","resolveInfo","kList","has","dict","get","i","length","createInfoBlock","push","key","sortList","infoMap","set","len","friendInfo","groupShareTicket","getGroupCloudStorage","shareTicket","kvDataList","Array","getUserCloudStorage","isGetMaxScoreSuccess","kVDataList","Key","value","saveCloudStorage","setUserCloudStorage","_this2","ListData","order","sort","a","b","AMaxScore","BMaxScore","_i","parseInt"],"mappings":"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","sourcesContent":["export class OpenCommon{\r\n    static groupShareTickets;\r\n    static isGetMaxScoreSuccess;\r\n    //最高分\r\n    static maxScore;\r\n    //用户信息\r\n    static userInfo;\r\n    //最后一条群句柄\r\n    static lastTicket;\r\n    //本地数据缓存\r\n    static localStorageMap : Map<any,Map<any,any>> = new Map();\r\n}","import {\r\n    OpenCommon\r\n} from \"./OpenCommon\";\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        content: cc.Node,\r\n        prefab: cc.Prefab\r\n    },\r\n    onLoad(){\r\n        //获取用户信息\r\n        this.getUserInfo((result) => {\r\n            console.info(\"[获取用户信息]\"+result);\r\n        });\r\n        //获取使用者信息\r\n        this.getUserMaxScoreData((result)=>{\r\n            OpenCommon.maxScore = result;\r\n            console.info(\"[获取用户最高分]\"+result);\r\n        })\r\n    },\r\n    start() {\r\n        let that = this;\r\n        this.rank = 0;\r\n        //监听主域通过微信API发送到子域的消息\r\n        wx.onMessage(data => {\r\n            if (data && data.message) {\r\n                //console.info(\"[子域收到消息]\" + data.message);\r\n                that.resolveMessage(data.message);\r\n            }\r\n        });\r\n    },\r\n    //创建使用者区块\r\n    createUserBlock(user) {\r\n        let that = this;\r\n        let node = this.createPrefab();\r\n        // getUserInfo will return the nickName, getFriendCloudStorage will return the nickname.\r\n        let nickName;\r\n        let avatarUrl;\r\n        let score;\r\n        let openid;\r\n        //如果存在信息\r\n        if(user){\r\n            nickName = user.nickName ? user.nickName : user.nickname;\r\n            avatarUrl = user.avatarUrl;\r\n            score = this.resolveCloudStorage(user.KVDataList, \"OneEatMaxScore\");\r\n            openid = user.openid;\r\n        }\r\n        //尝试解析数据\r\n        let userRank = node.getChildByName('rank').getComponent(cc.Label);\r\n        let userName = node.getChildByName('userName').getComponent(cc.Label);\r\n        let userIcon = node.getChildByName('mask').children[0].getComponent(cc.Sprite);\r\n        let userScore = node.getChildByName('userScore').getComponent(cc.Label);\r\n        \r\n        userIcon.enabled = false;\r\n\r\n        //如果名称存在则创建对应的区块，否则创建空区块\r\n        if (nickName) {\r\n            if (!score) {\r\n                score = \"null\";\r\n                userRank.string = \"null\";\r\n            }else{\r\n\r\n                that.rank += 1;\r\n                userRank.string = that.rank;\r\n                switch(that.rank){\r\n                    case 1:\r\n                        userRank.node.color = new cc.Color(255, 0, 0);\r\n                        break;\r\n                    case 2:\r\n                        userRank.node.color = new cc.Color(0, 255, 0);\r\n                        break;\r\n                    case 3:\r\n                        userRank.node.color = new cc.Color(0, 0, 255);\r\n                        break;\r\n                    default:\r\n                        userRank.fontSize = userRank.fontSize / 2;\r\n                        break;\r\n                }\r\n            }\r\n            userName.string = nickName;\r\n            userScore.string = score;\r\n            console.log(\"[获取好友信息]\" + nickName);\r\n            //如果头像存在\r\n            if (avatarUrl) {\r\n                cc.loader.load({\r\n                    url: avatarUrl,\r\n                    type: 'png'\r\n                }, (err, texture) => {\r\n                    if (err) console.error(err);\r\n                    userIcon.enabled = true;\r\n                    userIcon.spriteFrame = new cc.SpriteFrame(texture);\r\n                });\r\n            }\r\n            node.on(cc.Node.EventType.TOUCH_START, () => {\r\n                //console.info(\"[点击区块1]\" + userName.string + \"[分数]\" + userScore.string);\r\n            }, this);\r\n        }else{\r\n            userName.string = \"\";\r\n            userScore.string = \"\";\r\n            userIcon.spriteFrame = \"\";\r\n            userRank.string = \"\";\r\n        }\r\n    },\r\n    createPrefab() {\r\n        let node = cc.instantiate(this.prefab);\r\n        node.parent = this.content;\r\n        return node;\r\n    },\r\n    //分解主域传递过来的信息\r\n    resolveMessage(message) {\r\n        //console.info(\"[指令]\" + message.type);\r\n        switch (message.type) {\r\n            case \"command\":\r\n                this.resolveCommand(message.function, message.arguments, message.data);\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    },\r\n\r\n    resolveCommand(func, args, data) {\r\n        //console.info(\"[指令]\" + func + \"[参数]\" + args + \"[数据]\" + data);\r\n        switch (func) {\r\n            case \"clear\":\r\n                this.clearContext();\r\n                break;\r\n            case \"preload\":\r\n                switch (args) {\r\n                    case \"friend\": \r\n                        this.updateFriendInfo([\"OneEatMaxScore\"]);\r\n                        break;\r\n                    case \"group\":\r\n                        this.updateGroupInfo(data,[\"OneEatMaxScore\"]);\r\n                        break;\r\n                }\r\n                break;\r\n            case \"start\":\r\n                new Promise((resolve) => {\r\n                    this.clearContext();\r\n                    //获取用户信息\r\n                    this.getUserInfo((result) => {\r\n                        resolve(result);\r\n                    });\r\n                    if (data && data.width && data.height) {\r\n                        //console.info(\"[修正分辨率]\" + data.width + \",\" + data.height);\r\n                        //修改分辨率\r\n                        this.getComponent(cc.Canvas).designResolution = new cc.size(data.width, data.height);\r\n                    }\r\n                }).then((result) => {\r\n                    //console.info(\"[是否得到用户信息]\" + result);\r\n                    //获取朋友信息\r\n                    this.getFriendInfo([\"OneEatMaxScore\"]);\r\n                    //this.resolveCommand(\"switch\",\"friend\",\"\");\r\n                });\r\n                break;\r\n            case \"switch\":\r\n                this.clearContext();\r\n                switch (args) {\r\n                    case \"friend\":\r\n                        //获取好友最高分信息\r\n                        this.getFriendInfo([\"OneEatMaxScore\"]);\r\n                        break;\r\n                    case \"group\":\r\n                        //如果是从群分享卡片中打开的则可以查看同玩信息\r\n                        if (data) {\r\n                            //console.info(\"[根据]\" + data + \"[获取群组信息]\");\r\n                            OpenCommon.lastTicket = data;\r\n                            //获取群信息\r\n                            this.getGroupInfo(data, [\"OneEatMaxScore\"]);\r\n                        } else {\r\n                            //console.info(\"[无法获取群组信息]\");\r\n                        }\r\n                        break;\r\n                }\r\n                break;\r\n            case \"save\":\r\n                switch (args) {\r\n                    case \"gameDiamond\":\r\n                        //console.info(\"[存储游戏钻石]\" + data);\r\n                        break;\r\n                    case \"gameCurrency\":\r\n                        //console.info(\"[存储游戏币]\" + data);\r\n                        break;\r\n                    case \"score\":\r\n                        //console.info(\"[存储分数]\" + data);\r\n                        this.saveMaxScoreData(data);\r\n                        break;\r\n                    case \"shareTicket\":\r\n                        //console.info(\"[存储群识别码]\" + data);\r\n                        break;\r\n                }\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n    },\r\n    //移除容器内所有子节点\r\n    clearContext() {\r\n        this.rank = 0;\r\n        this.content.removeAllChildren();\r\n        //console.info(\"[清理容器]\");\r\n    },\r\n    getUserInfo(result) {\r\n        let that = this;\r\n        //如果没有用户信息则尝试获取用户信息\r\n        if (!OpenCommon.userInfo) {\r\n            //微信在子域内调用获取用户信息API\r\n            wx.getUserInfo({\r\n                openIdList: ['selfOpenId'],\r\n                lang: 'zh_CN',\r\n                success: (res) => {\r\n                    //获取用户信息\r\n                    let userInfo = res.data[0];\r\n                    //保存用户信息\r\n                    OpenCommon.userInfo = userInfo;\r\n                    //console.info(\"[获取用户信息成功]\" + userInfo);\r\n                    //尝试获取用户托管数据\r\n                    that.getUserMaxScoreData((score) => {\r\n                        let nickName = userInfo.nickName;\r\n                        let avatarUrl = userInfo.avatarUrl;\r\n                        let maxScore = score;\r\n                        //如果存在使用者区块\r\n                        if (that.userBlock) {\r\n                            let userAvatarSprite = that.userBlock.getChildByName('Mask').getComponentInChildren(cc.Sprite);\r\n                            let nickNameLabel = that.userBlock.getChildByName('Name').getComponent(cc.Label);\r\n                            let maxScoreLabel = that.userBlock.getChildByName('Score').getComponent(cc.Label);\r\n\r\n                            nickNameLabel.string = nickName;\r\n                            cc.loader.load({\r\n                                url: avatarUrl,\r\n                                type: 'png'\r\n                            }, (err, texture) => {\r\n                                if (err) console.error(err);\r\n                                userAvatarSprite.spriteFrame = new cc.SpriteFrame(texture);\r\n                            });\r\n                            //检查是否存在最高分\r\n                            if (maxScore) {\r\n                                maxScoreLabel.string = score;\r\n                            } else {\r\n                                maxScoreLabel.string = \"null\";\r\n                            }\r\n                        }\r\n                        result(true);\r\n                    });\r\n/*                     if(userInfo.nickName === \"彭云浩\"){\r\n                        console.info(\"[修改指定最高分]\");\r\n                        that.saveMaxScoreData(-9999);\r\n                    } */\r\n                },\r\n                fail: (res) => {\r\n                    //reject(res);\r\n                    //console.info(\"[获取用户信息失败]\" + res);\r\n                    result(false);\r\n                }\r\n            });\r\n        }else{\r\n            result(true);\r\n        }\r\n\r\n    },\r\n    //更新朋友信息\r\n    updateFriendInfo(keys){\r\n        let that = this;\r\n        wx.getFriendCloudStorage({\r\n            keyList: keys,\r\n            success: function (res) {\r\n                console.info(\"[成功更新朋友信息]\", res.data);\r\n                //解析数据信息\r\n                that.resolveInfo(\"Friend\", \"OneEatMaxScore\", res.data);\r\n            },\r\n            fail: function (res) {\r\n                console.error(res);\r\n            }\r\n        });\r\n    },\r\n    getFriendInfo(keys) {\r\n        let that = this;\r\n        let kList;\r\n\r\n        if (OpenCommon.localStorageMap.has(\"Friend\")) {\r\n            let dict = OpenCommon.localStorageMap.get(\"Friend\");\r\n\r\n            kList = [];\r\n            for (let i = 0; i < keys.length; i++) {\r\n                //如果有缓存信息\r\n                if (dict.has(keys[i])) {\r\n                    //console.info(\"[从缓存获取好友托管数据]\" + keys[i]);\r\n                    let data = dict.get(keys[i]);\r\n                    that.createInfoBlock(data, 10);\r\n                } else {\r\n                    kList.push(keys[i]);\r\n                }\r\n            }\r\n        } else {\r\n            kList = keys;\r\n        }\r\n\r\n        //如果有未缓存的数据则请求云端获取\r\n        if (kList.length > 0) {\r\n            //console.info(\"[开始获取好友托管数据]\" + kList);\r\n            // https://developers.weixin.qq.com/minigame/dev/document/open-api/data/wx.getFriendCloudStorage.html\r\n            wx.getFriendCloudStorage({\r\n                keyList: keys,\r\n                success: function (res) {\r\n                    console.info(\"[成功获取朋友信息]\", res.data);\r\n                    //解析数据信息\r\n                    let data = that.resolveInfo(\"Friend\", \"OneEatMaxScore\", res.data);\r\n                    that.createInfoBlock(data, 10);\r\n                },\r\n                fail: function (res) {\r\n                    console.error(res);\r\n                }\r\n            });\r\n        }\r\n    },\r\n    //解析数据信息\r\n    resolveInfo(type, key, data) {\r\n        let that = this;\r\n        //排序\r\n        that.sortList(data, key, false);\r\n        let infoMap;\r\n        if (OpenCommon.localStorageMap.has(type)) {\r\n            infoMap = OpenCommon.localStorageMap.get(type);\r\n        } else {\r\n            infoMap = new Map();\r\n            OpenCommon.localStorageMap.set(type, infoMap);\r\n            //console.info(\"[创建数据缓存]\"+infoMap);\r\n        }\r\n        //缓存数据信息\r\n        infoMap.set(key, data);\r\n\r\n        return data;\r\n    },\r\n    createInfoBlock(data, length) {\r\n        let that = this;\r\n        let len;\r\n        if(data.length>length){\r\n            len = data.length;\r\n        }else{\r\n            len = length;\r\n        }\r\n        for (let i = 0; i < len; i++) {\r\n            let friendInfo = data[i];\r\n            //如果朋友信息存在则创建信息否则创建空信息\r\n            if (friendInfo) {\r\n                that.createUserBlock(friendInfo);\r\n            } else {\r\n                that.createUserBlock();\r\n            }\r\n        }\r\n    },\r\n    updateGroupInfo(groupShareTicket, keys){\r\n        let that = this;\r\n        wx.getGroupCloudStorage({\r\n            shareTicket: groupShareTicket,\r\n            keyList: keys,\r\n            success: function (res) {\r\n                console.info(\"[成功更新群组信息]\", res.data);\r\n                //解析数据信息\r\n                that.resolveInfo(\"Group\", \"OneEatMaxScore\", res.data);\r\n            },\r\n            fail: function (res) {\r\n                console.error(res);\r\n            }\r\n        });\r\n    },\r\n    getGroupInfo(groupShareTicket, keys) {\r\n        let that = this;\r\n        let kList;\r\n\r\n        if (OpenCommon.localStorageMap.has(\"Group\")) {\r\n            let dict = OpenCommon.localStorageMap.get(\"Group\");\r\n\r\n            kList = [];\r\n            for (let i = 0; i < keys.length; i++) {\r\n                //如果有缓存信息\r\n                if (dict.has(keys[i])) {\r\n                    //console.info(\"[从缓存获取群组托管数据]\" + keys[i]);\r\n                    let data = dict.get(keys[i]);\r\n                    that.createInfoBlock(data, 10);\r\n                } else {\r\n                    kList.push(keys[i]);\r\n                }\r\n            }\r\n        } else {\r\n            kList = keys;\r\n        }\r\n\r\n        //如果有未缓存的数据则请求云端获取\r\n        if (kList.length > 0) {\r\n            //console.info(\"[开始获取好友托管数据]\" + kList);\r\n            // https://developers.weixin.qq.com/minigame/dev/document/open-api/data/wx.getFriendCloudStorage.html\r\n            wx.getGroupCloudStorage({\r\n                shareTicket: groupShareTicket,\r\n                keyList: keys,\r\n                success: function (res) {\r\n                    //console.info(\"[成功获取群组信息]\", res.data);\r\n                    //解析数据信息\r\n                    let data = that.resolveInfo(\"Group\", \"OneEatMaxScore\", res.data);\r\n                    that.createInfoBlock(data, 10);\r\n                },\r\n                fail: function (res) {\r\n                    console.error(res);\r\n                }\r\n            });\r\n        }\r\n    },\r\n    //获取用户的最高分记录\r\n    getUserMaxScoreData(result) {\r\n        let that = this;\r\n        let kvDataList = new Array();\r\n        //获取游戏最高分数\r\n        kvDataList.push(\"OneEatMaxScore\");\r\n        wx.getUserCloudStorage({\r\n            keyList: kvDataList,\r\n            success(res) {\r\n                //console.info(\"[获取用户托管数据成功]\" + res.KVDataList.length);\r\n                let score = that.resolveCloudStorage(res.KVDataList, \"OneEatMaxScore\");\r\n                if (score) {\r\n                    console.info(\"[获取托管最高分成功]\" + score)\r\n                    //OpenCommon.maxScore = score;\r\n                    result(score);\r\n                } else {\r\n                    that.saveMaxScoreData(0);\r\n                    result(0);\r\n                }\r\n                OpenCommon.isGetMaxScoreSuccess = true;\r\n            },\r\n            fail(res) {\r\n                //console.info(\"[获取托管数据失败]\");\r\n                OpenCommon.isGetMaxScoreSuccess = false;\r\n                result(0);\r\n            }\r\n        });\r\n    },\r\n    //解析云存储数据\r\n    resolveCloudStorage(kVDataList, Key) {\r\n        //数据无效则直接返回\r\n        if (!kVDataList) return null;\r\n        //console.log(\"[托管数据数量]\" + kVDataList.length);\r\n        for (let i = 0; i < kVDataList.length; i++) {\r\n            if (kVDataList[i].key === Key) {\r\n                return kVDataList[i].value;\r\n                //console.info(\"[获取托管键值]\" + Key + \"[数据]\" + kVDataList[i].value);\r\n                //break;\r\n            }\r\n        }\r\n    },\r\n    //存储托管数据\r\n    saveCloudStorage(kVDataList, success, fail) {\r\n        wx.setUserCloudStorage({\r\n            KVDataList: kVDataList,\r\n            success,\r\n            fail\r\n        });\r\n    },\r\n    saveMaxScoreData(value) {\r\n        if(!OpenCommon.maxScore||value<=OpenCommon.maxScore){\r\n            console.info(\"[最高分]\"+OpenCommon.maxScore +\"[但存储值]\"+value +\"[过低]\");\r\n            return;\r\n        }\r\n        let keys = [\"OneEatMaxScore\"];\r\n        let kvDataList = new Array();\r\n        kvDataList.push({\r\n            key: keys[0],\r\n            value: \"\" + value\r\n        });\r\n        //上报分数后立刻更新排行榜分数\r\n        if(OpenCommon.lastTicket){\r\n            //如果存在信息则进行更新\r\n            this.updateGroupInfo(OpenCommon.lastTicket,keys);\r\n        }\r\n        //存储分数数据\r\n        this.saveCloudStorage(kvDataList, () => {\r\n            console.info(\"[存储最高分数据成功]\");\r\n            this.updateFriendInfo(keys);\r\n        }, () => {\r\n            console.info(\"[存储最高分数据失败]\");\r\n        });\r\n    },\r\n    //排序(ListData：res.data;order:false降序，true升序)\r\n    sortList(ListData, key, order) {\r\n        ListData.sort(function (a, b) {\r\n            let AMaxScore = 0;\r\n            let KVDataList = a.KVDataList;\r\n            for (let i = 0; i < KVDataList.length; i++) {\r\n                if (KVDataList[i].key == key) {\r\n                    AMaxScore = KVDataList[i].value;\r\n                }\r\n            }\r\n            let BMaxScore = 0;\r\n            KVDataList = b.KVDataList;\r\n            for (let i = 0; i < KVDataList.length; i++) {\r\n                if (KVDataList[i].key == key) {\r\n                    BMaxScore = KVDataList[i].value;\r\n                }\r\n            }\r\n\r\n            if (order) {\r\n                return parseInt(AMaxScore) - parseInt(BMaxScore);\r\n            } else {\r\n                return parseInt(BMaxScore) - parseInt(AMaxScore);\r\n            }\r\n        });\r\n        return ListData;\r\n    }\r\n});"],"sourceRoot":"/source/","file":"project.js"}